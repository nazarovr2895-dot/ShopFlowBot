# üöÄ –£–ª—É—á—à–µ–Ω–∏—è deploy.sh

## –ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤ deploy.sh

–°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è —Ç–µ–ø–µ—Ä—å **—É–º–Ω–µ–µ** –∏ –¥–µ–ª–∞–µ—Ç –≤—Å—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!

### ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å–∫—Ä–∏–ø—Ç:

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç nginx** - –∏–∑–±–µ–≥–∞–µ—Ç 502 Bad Gateway –æ—à–∏–±–æ–∫
2. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç Backend** - `curl http://localhost/health`
3. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç Mini App** - `curl https://app.flowshow.ru`
4. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç Admin Panel** - `curl https://admin.flowshow.ru`
5. **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å** –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ (‚úÖ –∏–ª–∏ ‚ö†Ô∏è)

### –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:

```bash
./deploy.sh "feat: –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è"

üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π...
üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è:
 M backend/app/api/sellers.py
üíæ –ö–æ–º–º–∏—Ç–∏–º –∏ –ø—É—à–∏–º...
‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ GitHub
üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä...
[... Docker build logs ...]
üîß –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx...
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...
‚úÖ Backend: OK
‚úÖ Mini App: OK
‚úÖ Admin Panel: OK

‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!

üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç—ã:
   https://app.flowshow.ru
   https://admin.flowshow.ru
```

---

## üîß –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞: 502 Bad Gateway –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

**–ë—ã–ª–æ:**
–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –∏–Ω–æ–≥–¥–∞ nginx –Ω–µ –º–æ–≥ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ upstream –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º (miniapp, admin), –ø–æ–∫–∞–∑—ã–≤–∞—è 502 –æ—à–∏–±–∫—É.

**–°—Ç–∞–ª–æ:**
–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç nginx –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ - –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx
ssh yandex-cloud "docker compose -f ~/shopflowbot/docker-compose.prod.yml restart nginx"
```

---

## üìä Health Checks

### Backend Health Check

```bash
curl http://localhost/health
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "status": "healthy",
  "version": "1.0.0",
  "checks": {
    "database": "ok",
    "redis": "ok"
  }
}
```

### Frontend Health Checks

```bash
# Mini App
curl -I https://app.flowshow.ru
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: HTTP/2 200

# Admin Panel
curl -I https://admin.flowshow.ru
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: HTTP/2 200
```

---

## üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –û–±—ã—á–Ω—ã–π –¥–µ–ø–ª–æ–π:

```bash
./deploy.sh "feat: –¥–æ–±–∞–≤–∏–ª –∫–æ—Ä–∑–∏–Ω—É"
```

### –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç:

1. –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
2. Push –≤ GitHub
3. SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä
4. Git pull
5. Docker build (backend, bot, admin, miniapp)
6. Docker up -d (–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)
7. **Nginx restart** ‚≠ê (–Ω–æ–≤–æ–µ!)
8. **Health checks** ‚≠ê (–Ω–æ–≤–æ–µ!)
9. –í—ã–≤–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

---

## ‚ö†Ô∏è –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ—à–ª–∞

### Backend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ‚ö†Ô∏è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
ssh yandex-cloud 'cd ~/shopflowbot && docker compose -f docker-compose.prod.yml logs --tail 50 backend'

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
ssh yandex-cloud 'docker compose -f ~/shopflowbot/docker-compose.prod.yml ps backend'

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
ssh yandex-cloud 'docker compose -f ~/shopflowbot/docker-compose.prod.yml restart backend'
```

### Mini App –∏–ª–∏ Admin –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ‚ö†Ô∏è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ nginx
ssh yandex-cloud 'cd ~/shopflowbot && docker compose -f docker-compose.prod.yml logs --tail 50 nginx'

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
ssh yandex-cloud 'docker compose -f ~/shopflowbot/docker-compose.prod.yml ps'

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx –µ—â—ë —Ä–∞–∑
ssh yandex-cloud 'docker compose -f ~/shopflowbot/docker-compose.prod.yml restart nginx'
```

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:

```bash
# Backend
ssh yandex-cloud 'cd ~/shopflowbot && docker compose -f docker-compose.prod.yml logs --tail 20 backend'

# Nginx
ssh yandex-cloud 'cd ~/shopflowbot && docker compose -f docker-compose.prod.yml logs --tail 20 nginx'

# –í—Å—ë —Å—Ä–∞–∑—É
ssh yandex-cloud 'cd ~/shopflowbot && docker compose -f docker-compose.prod.yml logs --tail 20'
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:

```bash
ssh yandex-cloud 'docker compose -f ~/shopflowbot/docker-compose.prod.yml ps'
```

### –†—É—á–Ω–æ–π health check:

```bash
# –° –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
curl https://api.flowshow.ru/health

# –ò–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh yandex-cloud "curl http://localhost/health"
```

---

## üîÑ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –ë—ã–ª–æ vs –°—Ç–∞–ª–æ

### –ë—ã–ª–æ (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è):

```bash
./deploy.sh "feat: –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è"
# ... –¥–µ–ø–ª–æ–π ...
‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!

# –ù—É–∂–Ω–æ –±—ã–ª–æ –≤—Ä—É—á–Ω—É—é:
# 1. –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ —Å–∞–π—Ç
# 2. –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
# 3. –ò–Ω–æ–≥–¥–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å nginx –∏–∑-–∑–∞ 502
```

### –°—Ç–∞–ª–æ (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è):

```bash
./deploy.sh "feat: –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è"
# ... –¥–µ–ø–ª–æ–π ...
üîß –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx...
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...
‚úÖ Backend: OK
‚úÖ Mini App: OK
‚úÖ Admin Panel: OK
‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!

# –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É!
# –ù–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤—Ä—É—á–Ω—É—é
```

---

## üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. ‚úÖ **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx
2. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞** - health checks –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
3. ‚úÖ **–ù–∞–≥–ª—è–¥–Ω–æ—Å—Ç—å** - –≤–∏–¥–Ω–æ —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
4. ‚úÖ **–°–∫–æ—Ä–æ—Å—Ç—å** - –Ω–µ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤—Ä—É—á–Ω—É—é
5. ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - —Å—Ä–∞–∑—É –≤–∏–¥–Ω–æ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å

---

## üéì Best Practices

### 1. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤—ã–≤–æ–¥ —Å–∫—Ä–∏–ø—Ç–∞

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ ‚ö†Ô∏è - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

```bash
ssh yandex-cloud 'cd ~/shopflowbot && docker compose -f docker-compose.prod.yml logs --tail 50'
```

### 2. –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
docker-compose up -d
# –¢–µ—Å—Ç–∏—Ä—É–µ–º...
# –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç? –î–µ–ø–ª–æ–∏–º!
./deploy.sh "feat: ..."
```

### 3. –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º –≤ –≤—ã–≤–æ–¥–µ

```
‚úÖ Backend: OK          ‚Üí –í—Å—ë —Ö–æ—Ä–æ—à–æ
‚úÖ Mini App: OK         ‚Üí –í—Å—ë —Ö–æ—Ä–æ—à–æ
‚ö†Ô∏è  Admin Panel: ...    ‚Üí –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å!
```

---

## üÜò Troubleshooting

### –î–µ–ø–ª–æ–π –ø—Ä–æ—à—ë–ª, –Ω–æ —Å–∞–π—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ü–æ–¥–æ–∂–¥–∏—Ç–µ 5-10 —Å–µ–∫—É–Ω–¥** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –º–æ–≥—É—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è
2. **–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É** –≤ –±—Ä–∞—É–∑–µ—Ä–µ (F5 –∏–ª–∏ Cmd+R)
3. **Hard refresh** - Cmd+Shift+R (–æ—á–∏—Å—Ç–∏—Ç –∫—ç—à)
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** - `ssh yandex-cloud '... logs'`

### Health check –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ‚ö†Ô∏è –Ω–æ —Å–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç

–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑-–∑–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–µ—Ç–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä—É—á–Ω—É—é:

```bash
curl https://app.flowshow.ru
# –ï—Å–ª–∏ –æ—Ç–≤–µ—á–∞–µ—Ç - –≤—Å—ë –û–ö
```

### –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚ö†Ô∏è

–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –∏–ª–∏ —Å–µ—Ç—å—é:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω
ssh yandex-cloud "echo 'Server is reachable'"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
ssh yandex-cloud 'docker compose -f ~/shopflowbot/docker-compose.prod.yml ps'
```

---

## üìö –°–º. —Ç–∞–∫–∂–µ

- **–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è**: `SIMPLE_SOLUTION.md`
- **–ö–æ–º–∞–Ω–¥—ã —Å–µ—Ä–≤–µ—Ä–∞**: `SERVER_COMMANDS.md`
- **–ì–ª–∞–≤–Ω—ã–π –≥–∞–π–¥**: `CLAUDE.md`

---

**–°–æ–∑–¥–∞–Ω–æ:** 2025-02-15
**–í–µ—Ä—Å–∏—è:** 2.0.0
