# üîÑ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞–º–∏ Nginx (301 vs 302)

## –ü—Ä–æ–±–ª–µ–º–∞

**HTTP 301** (Permanent Redirect) - –±—Ä–∞—É–∑–µ—Ä –∫—ç—à–∏—Ä—É–µ—Ç **–ù–ê–í–°–ï–ì–î–ê**
**HTTP 302** (Temporary Redirect) - –±—Ä–∞—É–∑–µ—Ä **–ù–ï** –∫—ç—à–∏—Ä—É–µ—Ç

## –†–µ—à–µ–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑—É–µ–º **—Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏** –¥–ª—è development –∏ production.

---

## üìÅ –§–∞–π–ª—ã

```
nginx/
‚îú‚îÄ‚îÄ nginx.prod.conf      # Production (301 —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã)
‚îú‚îÄ‚îÄ nginx.dev.conf       # Development (302 —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã)
‚îú‚îÄ‚îÄ nginx.conf           # –°–∏–º–ª–∏–Ω–∫ ‚Üí prod –∏–ª–∏ dev
‚îú‚îÄ‚îÄ switch-config.sh     # –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
‚îî‚îÄ‚îÄ README.md            # –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

---

## üöÄ –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```bash
./nginx/switch-config.sh status
```

### –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ Development (302):

```bash
./nginx/switch-config.sh dev
docker compose restart nginx
```

### –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ Production (301):

```bash
./nginx/switch-config.sh prod
docker compose -f docker-compose.prod.yml restart nginx
```

---

## üí° –ö–æ–≥–¥–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### Development (302) - –õ–æ–∫–∞–ª—å–Ω–æ –∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
./nginx/switch-config.sh dev
```

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–≥–¥–∞:**
- ‚úÖ –†–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ
- ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ—Ç–µ –Ω–æ–≤—ã–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã
- ‚úÖ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–µ—Ç–µ —Å –¥–æ–º–µ–Ω–∞–º–∏
- ‚úÖ –ù–∞ staging —Å–µ—Ä–≤–µ—Ä–µ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ë—Ä–∞—É–∑–µ—Ä –ù–ï –∫—ç—à–∏—Ä—É–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã
- –ú–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –º–µ–Ω—è—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### Production (301) - –ù–∞ production —Å–µ—Ä–≤–µ—Ä–µ

```bash
./nginx/switch-config.sh prod
```

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–≥–¥–∞:**
- ‚úÖ Production —Å–µ—Ä–≤–µ—Ä
- ‚úÖ –£–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–∞

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ë—ã—Å—Ç—Ä–µ–µ (–±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–π —Ä–∞–∑)
- SEO –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–ø–æ–∏—Å–∫–æ–≤–∏–∫–∏ –ø–æ–Ω–∏–º–∞—é—Ç —á—Ç–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π)

---

## üîß –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ

### –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –¥–µ–ø–ª–æ–µ:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh yandex-cloud
cd ~/flurai/nginx

# –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è prod –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
ls -la nginx.conf  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: nginx.conf -> nginx.prod.conf

# –ï—Å–ª–∏ –Ω–µ—Ç - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å
ln -sf nginx.prod.conf nginx.conf

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx
docker compose -f docker-compose.prod.yml restart nginx
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫–∏–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
docker compose exec nginx cat /etc/nginx/conf.d/default.conf | grep "return 30"

# Production –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å:
# return 301 https://...

# Development –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å:
# return 302 https://...
```

---

## üêõ –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –∫—ç—à–∏—Ä–æ–≤–∞–ª —Å—Ç–∞—Ä—ã–π 301 —Ä–µ–¥–∏—Ä–µ–∫—Ç

### –°–ø–æ—Å–æ–± 1: –û—á–∏—Å—Ç–∏—Ç—å HSTS (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```
1. –û—Ç–∫—Ä—ã—Ç—å: chrome://net-internals/#hsts
2. –í —Ä–∞–∑–¥–µ–ª–µ "Delete domain security policies"
3. –í–≤–µ—Å—Ç–∏: app.flurai.ru
4. –ù–∞–∂–∞—Ç—å: Delete
5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Chrome
```

### –°–ø–æ—Å–æ–± 2: Hard Refresh

- **Mac**: `Cmd + Shift + R`
- **Windows**: `Ctrl + Shift + R`

### –°–ø–æ—Å–æ–± 3: –†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ

–û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ä–∞–∑—É.

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ production –¥–µ–ø–ª–æ–µ–º

- [ ] –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `nginx.dev.conf`
- [ ] –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `nginx.prod.conf`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª–∏ —Å–∏–º–ª–∏–Ω–∫: `ls -la nginx/nginx.conf`
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª–∏ nginx –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## üîç Troubleshooting: CORS –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

### –ü—Ä–æ–±–ª–µ–º–∞: "Failed to fetch" –ø–µ—Ä–≤—ã–µ 10 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è admin.flurai.ru –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç CORS –æ—à–∏–±–∫–∏
- –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞: `Access to fetch at 'https://flurai.ru/admin/login' has been blocked by CORS policy`
- –ß–µ—Ä–µ–∑ 10-15 —Å–µ–∫—É–Ω–¥ –≤—Å—ë –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ

**–ü—Ä–∏—á–∏–Ω–∞:**
- Nginx –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ —á–µ–º backend –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
- Backend "–ø—Ä–æ–≥—Ä–µ–≤–∞–µ—Ç—Å—è" –ø–µ—Ä–≤—ã–µ 5-10 —Å–µ–∫—É–Ω–¥ (SQLAlchemy, Redis, middleware)
- Race condition –º–µ–∂–¥—É nginx –∏ backend –ø—Ä–∏ –¥–µ–ø–ª–æ–µ

**–†–µ—à–µ–Ω–∏–µ:**
Nginx —Ç–µ–ø–µ—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö upstream:

```nginx
# –í –∫–∞–∂–¥–æ–º location –±–ª–æ–∫–µ –¥–ª—è backend:
proxy_next_upstream error timeout http_502 http_503 http_504;
proxy_next_upstream_tries 3;           # –î–æ 3 –ø–æ–ø—ã—Ç–æ–∫
proxy_next_upstream_timeout 10s;       # –í —Ç–µ—á–µ–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥

# Keepalive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
keepalive 32;
proxy_http_version 1.1;
proxy_set_header Connection "";

# –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã:
proxy_connect_timeout 15s;  # –ë—ã–ª–æ 10s
```

**–ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç:**
- –ï—Å–ª–∏ backend –≤–µ—Ä–Ω—É–ª 502/503/504 ‚Üí nginx –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å
- –ö–ª–∏–µ–Ω—Ç (–±—Ä–∞—É–∑–µ—Ä) –Ω–µ –≤–∏–¥–∏—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏ retry —É—Å–ø–µ—à–µ–Ω
- Keepalive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç "—Ö–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç" backend

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```bash
# –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –æ—Ç–∫—Ä—ã—Ç—å admin.flurai.ru
# –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ CORS –æ—à–∏–±–æ–∫!

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ nginx
ssh yandex-cloud "docker compose -f ~/flurai/docker-compose.prod.yml logs nginx | grep upstream | tail -20"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å keepalive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
ssh yandex-cloud "docker compose exec nginx netstat -tnp | grep :8000"
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å ESTABLISHED —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–∞–∂–µ –±–µ–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
```

**–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å healthcheck backend: `curl https://flurai.ru/health`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ backend: `docker compose logs backend | grep -E '(startup|CORS)'`
3. –£–≤–µ–ª–∏—á–∏—Ç—å `start_period` –≤ `docker-compose.prod.yml` (—Å–µ–π—á–∞—Å 60s)
4. –î–æ–±–∞–≤–∏—Ç—å startup delay –¥–ª—è nginx (—Å–º. –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –≤ –ø–ª–∞–Ω–µ)

---

## üéØ Workflow

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:

```bash
# 1. –õ–æ–∫–∞–ª—å–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º dev –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
./nginx/switch-config.sh dev
docker compose restart nginx

# 2. –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
# –ë—Ä–∞—É–∑–µ—Ä –ù–ï –∫—ç—à–∏—Ä—É–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã - –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å

# 3. –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
git add nginx/
git commit -m "feat: –æ–±–Ω–æ–≤–ª–µ–Ω–∞ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"

# 4. –î–µ–ø–ª–æ–∏–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
./deploy.sh "feat: –æ–±–Ω–æ–≤–ª–µ–Ω–∞ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"

# 5. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è prod –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (301)
```

---

## üìö –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–º. `nginx/README.md` –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

---

**–°–æ–∑–¥–∞–Ω–æ:** 2025-02-14
**–í–µ—Ä—Å–∏—è:** 1.0.0
